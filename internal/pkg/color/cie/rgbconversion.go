package cie

import (
	"pathtracer/internal/pkg/color"
	"pathtracer/internal/pkg/util"
)

type matrix3x3 [][]float64
type RGBtoXYZ matrix3x3
type XYZtoRGB matrix3x3

var (
	AdobeRGB1998_D65_RGBtoXYZ  RGBtoXYZ
	AdobeRGB1998_D65_XYZtoRGB  XYZtoRGB
	AppleRGB_D65_RGBtoXYZ      RGBtoXYZ
	AppleRGB_D65_XYZtoRGB      XYZtoRGB
	BestRGB_D50_RGBtoXYZ       RGBtoXYZ
	BestRGB_D50_XYZtoRGB       XYZtoRGB
	BetaRGB_D50_RGBtoXYZ       RGBtoXYZ
	BetaRGB_D50_XYZtoRGB       XYZtoRGB
	BruceRGB_D65_RGBtoXYZ      RGBtoXYZ
	BruceRGB_D65_XYZtoRGB      XYZtoRGB
	CIERGB_E_RGBtoXYZ          RGBtoXYZ
	CIERGB_E_XYZtoRGB          XYZtoRGB
	ColorMatchRGB_D50_RGBtoXYZ RGBtoXYZ
	ColorMatchRGB_D50_XYZtoRGB XYZtoRGB
	DonRGB4_D50_RGBtoXYZ       RGBtoXYZ
	DonRGB4_D50_XYZtoRGB       XYZtoRGB
	ECIRGB_D50_RGBtoXYZ        RGBtoXYZ
	ECIRGB_D50_XYZtoRGB        XYZtoRGB
	EktaSpacePS5_D50_RGBtoXYZ  RGBtoXYZ
	EktaSpacePS5_D50_XYZtoRGB  XYZtoRGB
	NTSCRGB_C_RGBtoXYZ         RGBtoXYZ
	NTSCRGB_C_XYZtoRGB         XYZtoRGB
	PALSECAMRGB_D65_RGBtoXYZ   RGBtoXYZ
	PALSECAMRGB_D65_XYZtoRGB   XYZtoRGB
	ProPhotoRGB_D50_RGBtoXYZ   RGBtoXYZ
	ProPhotoRGB_D50_XYZtoRGB   XYZtoRGB
	SMPTECRGB_D65_RGBtoXYZ     RGBtoXYZ
	SMPTECRGB_D65_XYZtoRGB     XYZtoRGB
	SRGB_D65_RGBtoXYZ          RGBtoXYZ
	SRGB_D65_XYZtoRGB          XYZtoRGB
	WideGamutRGB_D50_RGBtoXYZ  RGBtoXYZ
	WideGamutRGB_D50_XYZtoRGB  XYZtoRGB

	AdobeRGB1998_D50_RGBtoXYZ RGBtoXYZ
	AdobeRGB1998_D50_XYZtoRGB XYZtoRGB
	AppleRGB_D50_RGBtoXYZ     RGBtoXYZ
	AppleRGB_D50_XYZtoRGB     XYZtoRGB
	BruceRGB_D50_RGBtoXYZ     RGBtoXYZ
	BruceRGB_D50_XYZtoRGB     XYZtoRGB
	CIERGB_D50_RGBtoXYZ       RGBtoXYZ
	CIERGB_D50_XYZtoRGB       XYZtoRGB
	NTSCRGB_D50_RGBtoXYZ      RGBtoXYZ
	NTSCRGB_D50_XYZtoRGB      XYZtoRGB
	PALSECAMRGB_D50_RGBtoXYZ  RGBtoXYZ
	PALSECAMRGB_D50_XYZtoRGB  XYZtoRGB
	SMPTECRGB_D50_RGBtoXYZ    RGBtoXYZ
	SMPTECRGB_D50_XYZtoRGB    XYZtoRGB
	SRGB_D50_RGBtoXYZ         RGBtoXYZ
	SRGB_D50_XYZtoRGB         XYZtoRGB

	XYZ_WhitePoint_D65toD50 matrix3x3
	XYZ_WhitePoint_D50toD65 matrix3x3
)

// D65_SRGB converts CIE 1931 XYZ to sRGB (with reference to D65 white point).
// Result sRGB is gamma corrected using sRGB gamma compression (gamma = 2.4).
//
// https://en.wikipedia.org/wiki/SRGB
//
// | R_linear |   | +3.2406 -1.5372 -0.4986 |   | X_d65 |
// | G_linear | = | -0.9689 +1.8758 +0.0415 | * | Y_d65 |
// | B_linear |   | +0.0557 -0.2040 +1.0570 |   | Z_d65 |
//
// https://color.org/chardata/rgb/sRGB.pdf
// | R_linear |   | +3.2406255 -1.5372080 -0.4986286 |   | X_d65 |
// | G_linear | = | -0.9689307 +1.8757561 +0.0415175 | * | Y_d65 |
// | B_linear |   | +0.0557101 -0.2040211 +1.0569959 |   | Z_d65 |
func (xyz CIEXYZ) D65_SRGB() color.Color {
	nxyz := xyz.NormalizeYLevel(1.0)

	rLinear := +3.2406255*nxyz.X + -1.5372080*nxyz.Y + -0.4986286*nxyz.Z
	gLinear := -0.9689307*nxyz.X + +1.8757561*nxyz.Y + +0.0415175*nxyz.Z
	bLinear := +0.0557101*nxyz.X + -0.2040211*nxyz.Y + +1.0569959*nxyz.Z

	return color.Color{
		R: float32(util.ClampFloat64(0.0, 1.0, srgbGammaCompression(rLinear))),
		G: float32(util.ClampFloat64(0.0, 1.0, srgbGammaCompression(gLinear))),
		B: float32(util.ClampFloat64(0.0, 1.0, srgbGammaCompression(bLinear))),
		A: float32(1.0),
	}
}

// RGB converts CIE 1931 XYZ to RGB (with reference to a specified white point).
// Result RGB color is gamma corrected using gamma compression.
func (xyz CIEXYZ) RGB(conversionMatrix XYZtoRGB, gamma float64) color.Color {
	m := conversionMatrix
	nxyz := xyz.NormalizeYLevel(1.0)

	rLinear := m[0][0]*nxyz.X + m[0][1]*nxyz.Y + m[0][2]*nxyz.Z
	gLinear := m[1][0]*nxyz.X + m[1][1]*nxyz.Y + m[1][2]*nxyz.Z
	bLinear := m[2][0]*nxyz.X + m[2][1]*nxyz.Y + m[2][2]*nxyz.Z

	return color.Color{
		R: float32(util.ClampFloat64(0.0, 1.0, GammaCompression(rLinear, gamma))),
		G: float32(util.ClampFloat64(0.0, 1.0, GammaCompression(gLinear, gamma))),
		B: float32(util.ClampFloat64(0.0, 1.0, GammaCompression(bLinear, gamma))),
		A: float32(1.0),
	}
}

func RGBColorToXYZ(c color.Color, conversionMatrix RGBtoXYZ, gamma float64, Ylevel float64) CIEXYZ {
	m := conversionMatrix

	R := GammaExpansion(float64(c.R), gamma)
	G := GammaExpansion(float64(c.G), gamma)
	B := GammaExpansion(float64(c.B), gamma)

	X := m[0][0]*R + m[0][1]*G + m[0][2]*B
	Y := m[1][0]*R + m[1][1]*G + m[1][2]*B
	Z := m[2][0]*R + m[2][1]*G + m[2][2]*B

	cieXYZ := CIEXYZ{X: X, Y: Y, Z: Z}
	cieXYZ.NormalizeYLevel(Ylevel)

	return cieXYZ
}

func (xyz CIEXYZ) D65toD50() CIEXYZ {
	m := XYZ_WhitePoint_D65toD50

	return CIEXYZ{
		m[0][0]*xyz.X + m[0][1]*xyz.Y + m[0][2]*xyz.Z,
		m[1][0]*xyz.X + m[1][1]*xyz.Y + m[1][2]*xyz.Z,
		m[2][0]*xyz.X + m[2][1]*xyz.Y + m[2][2]*xyz.Z,
	}
}

func (xyz CIEXYZ) D50toD65() CIEXYZ {
	m := XYZ_WhitePoint_D50toD65

	return CIEXYZ{
		m[0][0]*xyz.X + m[0][1]*xyz.Y + m[0][2]*xyz.Z,
		m[1][0]*xyz.X + m[1][1]*xyz.Y + m[1][2]*xyz.Z,
		m[2][0]*xyz.X + m[2][1]*xyz.Y + m[2][2]*xyz.Z,
	}
}

func init() {
	// http://www.brucelindbloom.com/index.html?Eqn_RGB_XYZ_Matrix.html

	AdobeRGB1998_D65_RGBtoXYZ = RGBtoXYZ{{0.5767309, 0.1855540, 0.1881852}, {0.2973769, 0.6273491, 0.0752741}, {0.0270343, 0.0706872, 0.9911085}}
	AdobeRGB1998_D65_XYZtoRGB = XYZtoRGB{{2.0413690, -0.5649464, -0.3446944}, {-0.9692660, 1.8760108, 0.0415560}, {0.0134474, -0.1183897, 1.0154096}}
	AppleRGB_D65_RGBtoXYZ = RGBtoXYZ{{0.4497288, 0.3162486, 0.1844926}, {0.2446525, 0.6720283, 0.0833192}, {0.0251848, 0.1411824, 0.9224628}}
	AppleRGB_D65_XYZtoRGB = XYZtoRGB{{2.9515373, -1.2894116, -0.4738445}, {-1.0851093, 1.9908566, 0.0372026}, {0.0854934, -0.2694964, 1.0912975}}
	BestRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.6326696, 0.2045558, 0.1269946}, {0.2284569, 0.7373523, 0.0341908}, {0.0000000, 0.0095142, 0.8156958}}
	BestRGB_D50_XYZtoRGB = XYZtoRGB{{1.7552599, -0.4836786, -0.2530000}, {-0.5441336, 1.5068789, 0.0215528}, {0.0063467, -0.0175761, 1.2256959}}
	BetaRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.6712537, 0.1745834, 0.1183829}, {0.3032726, 0.6637861, 0.0329413}, {0.0000000, 0.0407010, 0.7845090}}
	BetaRGB_D50_XYZtoRGB = XYZtoRGB{{1.6832270, -0.4282363, -0.2360185}, {-0.7710229, 1.7065571, 0.0446900}, {0.0400013, -0.0885376, 1.2723640}}
	BruceRGB_D65_RGBtoXYZ = RGBtoXYZ{{0.4674162, 0.2944512, 0.1886026}, {0.2410115, 0.6835475, 0.0754410}, {0.0219101, 0.0736128, 0.9933071}}
	BruceRGB_D65_XYZtoRGB = XYZtoRGB{{2.7454669, -1.1358136, -0.4350269}, {-0.9692660, 1.8760108, 0.0415560}, {0.0112723, -0.1139754, 1.0132541}}
	CIERGB_E_RGBtoXYZ = RGBtoXYZ{{0.4887180, 0.3106803, 0.2006017}, {0.1762044, 0.8129847, 0.0108109}, {0.0000000, 0.0102048, 0.9897952}}
	CIERGB_E_XYZtoRGB = XYZtoRGB{{2.3706743, -0.9000405, -0.4706338}, {-0.5138850, 1.4253036, 0.0885814}, {0.0052982, -0.0146949, 1.0093968}}
	ColorMatchRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.5093439, 0.3209071, 0.1339691}, {0.2748840, 0.6581315, 0.0669845}, {0.0242545, 0.1087821, 0.6921735}}
	ColorMatchRGB_D50_XYZtoRGB = XYZtoRGB{{2.6422874, -1.2234270, -0.3930143}, {-1.1119763, 2.0590183, 0.0159614}, {0.0821699, -0.2807254, 1.4559877}}
	DonRGB4_D50_RGBtoXYZ = RGBtoXYZ{{0.6457711, 0.1933511, 0.1250978}, {0.2783496, 0.6879702, 0.0336802}, {0.0037113, 0.0179861, 0.8035125}}
	DonRGB4_D50_XYZtoRGB = XYZtoRGB{{1.7603902, -0.4881198, -0.2536126}, {-0.7126288, 1.6527432, 0.0416715}, {0.0078207, -0.0347411, 1.2447743}}
	ECIRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.6502043, 0.1780774, 0.1359384}, {0.3202499, 0.6020711, 0.0776791}, {0.0000000, 0.0678390, 0.7573710}}
	ECIRGB_D50_XYZtoRGB = XYZtoRGB{{1.7827618, -0.4969847, -0.2690101}, {-0.9593623, 1.9477962, -0.0275807}, {0.0859317, -0.1744674, 1.3228273}}
	EktaSpacePS5_D50_RGBtoXYZ = RGBtoXYZ{{0.5938914, 0.2729801, 0.0973485}, {0.2606286, 0.7349465, 0.0044249}, {0.0000000, 0.0419969, 0.7832131}}
	EktaSpacePS5_D50_XYZtoRGB = XYZtoRGB{{2.0043819, -0.7304844, -0.2450052}, {-0.7110285, 1.6202126, 0.0792227}, {0.0381263, -0.0868780, 1.2725438}}
	NTSCRGB_C_RGBtoXYZ = RGBtoXYZ{{0.6068909, 0.1735011, 0.2003480}, {0.2989164, 0.5865990, 0.1144845}, {0.0000000, 0.0660957, 1.1162243}}
	NTSCRGB_C_XYZtoRGB = XYZtoRGB{{1.9099961, -0.5324542, -0.2882091}, {-0.9846663, 1.9991710, -0.0283082}, {0.0583056, -0.1183781, 0.8975535}}
	PALSECAMRGB_D65_RGBtoXYZ = RGBtoXYZ{{0.4306190, 0.3415419, 0.1783091}, {0.2220379, 0.7066384, 0.0713236}, {0.0201853, 0.1295504, 0.9390944}}
	PALSECAMRGB_D65_XYZtoRGB = XYZtoRGB{{3.0628971, -1.3931791, -0.4757517}, {-0.9692660, 1.8760108, 0.0415560}, {0.0678775, -0.2288548, 1.0693490}}
	ProPhotoRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.7976749, 0.1351917, 0.0313534}, {0.2880402, 0.7118741, 0.0000857}, {0.0000000, 0.0000000, 0.8252100}}
	ProPhotoRGB_D50_XYZtoRGB = XYZtoRGB{{1.3459433, -0.2556075, -0.0511118}, {-0.5445989, 1.5081673, 0.0205351}, {0.0000000, 0.0000000, 1.2118128}}
	SMPTECRGB_D65_RGBtoXYZ = RGBtoXYZ{{0.3935891, 0.3652497, 0.1916313}, {0.2124132, 0.7010437, 0.0865432}, {0.0187423, 0.1119313, 0.9581563}}
	SMPTECRGB_D65_XYZtoRGB = XYZtoRGB{{3.5053960, -1.7394894, -0.5439640}, {-1.0690722, 1.9778245, 0.0351722}, {0.0563200, -0.1970226, 1.0502026}}
	SRGB_D65_RGBtoXYZ = RGBtoXYZ{{0.4124564, 0.3575761, 0.1804375}, {0.2126729, 0.7151522, 0.0721750}, {0.0193339, 0.1191920, 0.9503041}}
	SRGB_D65_XYZtoRGB = XYZtoRGB{{3.2404542, -1.5371385, -0.4985314}, {-0.9692660, 1.8760108, 0.0415560}, {0.0556434, -0.2040259, 1.0572252}}
	WideGamutRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.7161046, 0.1009296, 0.1471858}, {0.2581874, 0.7249378, 0.0168748}, {0.0000000, 0.0517813, 0.7734287}}
	WideGamutRGB_D50_XYZtoRGB = XYZtoRGB{{1.4628067, -0.1840623, -0.2743606}, {-0.5217933, 1.4472381, 0.0677227}, {0.0349342, -0.0968930, 1.2884099}}

	AdobeRGB1998_D50_RGBtoXYZ = RGBtoXYZ{{0.6097559, 0.2052401, 0.1492240}, {0.3111242, 0.6256560, 0.0632197}, {0.0194811, 0.0608902, 0.7448387}}
	AdobeRGB1998_D50_XYZtoRGB = XYZtoRGB{{1.9624274, -0.6105343, -0.3413404}, {-0.9787684, 1.9161415, 0.0334540}, {0.0286869, -0.1406752, 1.3487655}}
	AppleRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.4755678, 0.3396722, 0.1489800}, {0.2551812, 0.6725693, 0.0722496}, {0.0184697, 0.1133771, 0.6933632}}
	AppleRGB_D50_XYZtoRGB = XYZtoRGB{{2.8510695, -1.3605261, -0.4708281}, {-1.0927680, 2.0348871, 0.0227598}, {0.1027403, -0.2964984, 1.4510659}}
	BruceRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.4941816, 0.3204834, 0.1495550}, {0.2521531, 0.6844869, 0.0633600}, {0.0157886, 0.0629304, 0.7464909}}
	BruceRGB_D50_XYZtoRGB = XYZtoRGB{{2.6502856, -1.2014485, -0.4289936}, {-0.9787684, 1.9161415, 0.0334540}, {0.0264570, -0.1361227, 1.3458542}}
	CIERGB_D50_RGBtoXYZ = RGBtoXYZ{{0.4868870, 0.3062984, 0.1710347}, {0.1746583, 0.8247541, 0.0005877}, {-0.0012563, 0.0169832, 0.8094831}}
	CIERGB_D50_XYZtoRGB = XYZtoRGB{{2.3638081, -0.8676030, -0.4988161}, {-0.5005940, 1.3962369, 0.1047562}, {0.0141712, -0.0306400, 1.2323842}}
	NTSCRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.6343706, 0.1852204, 0.1446290}, {0.3109496, 0.5915984, 0.0974520}, {-0.0011817, 0.0555518, 0.7708399}}
	NTSCRGB_D50_XYZtoRGB = XYZtoRGB{{1.8464881, -0.5521299, -0.2766458}, {-0.9826630, 2.0044755, -0.0690396}, {0.0736477, -0.1453020, 1.3018376}}
	PALSECAMRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.4552773, 0.3675500, 0.1413926}, {0.2323025, 0.7077956, 0.0599019}, {0.0145457, 0.1049154, 0.7057489}}
	PALSECAMRGB_D50_XYZtoRGB = XYZtoRGB{{2.9603944, -1.4678519, -0.4685105}, {-0.9787684, 1.9161415, 0.0334540}, {0.0844874, -0.2545973, 1.4216174}}
	SMPTECRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.4163290, 0.3931464, 0.1547446}, {0.2216999, 0.7032549, 0.0750452}, {0.0136576, 0.0913604, 0.7201920}}
	SMPTECRGB_D50_XYZtoRGB = XYZtoRGB{{3.3921940, -1.8264027, -0.5385522}, {-1.0770996, 2.0213975, 0.0207989}, {0.0723073, -0.2217902, 1.3960932}}
	SRGB_D50_RGBtoXYZ = RGBtoXYZ{{0.4360747, 0.3850649, 0.1430804}, {0.2225045, 0.7168786, 0.0606169}, {0.0139322, 0.0971045, 0.7141733}}
	SRGB_D50_XYZtoRGB = XYZtoRGB{{3.1338561, -1.6168667, -0.4906146}, {-0.9787684, 1.9161415, 0.0334540}, {0.0719453, -0.2289914, 1.4052427}}

	// https://color.org/chardata/rgb/sRGB.pdf

	XYZ_WhitePoint_D65toD50 = matrix3x3{{1.047844353856414, 0.022898981050086, -0.050206647741605}, {0.029549007606644, 0.990508028941971, -0.017074711360960}, {-0.009250984365223, 0.015072338237051, 0.751717835079977}}
	XYZ_WhitePoint_D50toD65 = matrix3x3{{0.95554914713390366063, -0.023053959026109212273, 0.063296728524184200469}, {-0.028293615880275730312, 1.0099167256211721654, 0.0210497985338695162}, {0.012326727844429517029, -0.020533074478247800045, 1.3306432822046877115}}
}
